<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ·±å…¥ Python â€”â€” åˆ‡ç‰‡ï¼ˆSliceï¼‰åŸç† | Protream&#39;s Notes</title>
<link rel="shortcut icon" href="https://protream.github.io/favicon.ico?v=1733235889358">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://protream.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="æ·±å…¥ Python â€”â€” åˆ‡ç‰‡ï¼ˆSliceï¼‰åŸç† | Protream&#39;s Notes - Atom Feed" href="https://protream.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="åœ¨é˜…è¯»æœ¬æ–‡å‰ï¼Œå…ˆæ¥æµ‹è¯•ä¸€ä¸‹å¯¹åˆ‡ç‰‡çš„æŒæ¡æƒ…å†µå§ï¼Œå°è¯•å›ç­”ä¸‹é¢å‡ ä¸ªé—®é¢˜:
a = [1, 2, 3, 4, 5]


è·å– [2, 3, 4]
è·å– [2, 4]
è·å– [5, 3, 1]
a[:-1] = ?
a[::-1] = ?
a[-1..." />
    <meta name="keywords" content="python" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://protream.github.io">
  <img class="avatar" src="https://protream.github.io/images/avatar.png?v=1733235889358" alt="">
  </a>
  <h1 class="site-title">
    Protream&#39;s Notes
  </h1>
  <p class="site-description">
    
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              æ·±å…¥ Python â€”â€” åˆ‡ç‰‡ï¼ˆSliceï¼‰åŸç†
            </h2>
            <div class="post-info">
              <span>
                2019-04-03
              </span>
              <span>
                13 min read
              </span>
              
                <a href="https://protream.github.io/tag/A0Yg_mO4u/" class="post-tag">
                  # python
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>åœ¨é˜…è¯»æœ¬æ–‡å‰ï¼Œå…ˆæ¥æµ‹è¯•ä¸€ä¸‹å¯¹åˆ‡ç‰‡çš„æŒæ¡æƒ…å†µå§ï¼Œå°è¯•å›ç­”ä¸‹é¢å‡ ä¸ªé—®é¢˜:</p>
<pre><code class="language-py">a = [1, 2, 3, 4, 5]
</code></pre>
<ol>
<li>è·å– [2, 3, 4]</li>
<li>è·å– [2, 4]</li>
<li>è·å– [5, 3, 1]</li>
<li>a[:-1] = ?</li>
<li>a[::-1] = ?</li>
<li>a[-1:-2] = ?</li>
<li>a[6:-1] = ?</li>
<li>a[ğŸ‘-1] = ?</li>
<li>a[1ğŸ‘0] = ?</li>
<li>åˆ‡ç‰‡è¿”å›çš„æ˜¯åºåˆ—çš„æ·±æ‹·è´è¿˜æ˜¯æµ…æ‹·è´ï¼Ÿ</li>
</ol>
<!--more-->
<p>å¦‚æœåœ¨ä¸å€ŸåŠ© Python è§£é‡Šå™¨çš„æƒ…å†µä¸‹ä½ èƒ½å¾ˆå¿«çš„è¯´å‡ºç­”æ¡ˆï¼Œé‚£è¯´æ˜ä½ å·²ç»å¯¹åˆ‡ç‰‡æŒæ¡çš„ä¸é”™äº†ã€‚ç›¸ä¿¡è¿˜æ˜¯æœ‰å¾ˆå¤šäººä¸èƒ½å®Œå…¨è§£ç­”å‡ºæ¥æˆ–è€…å¯¹å…¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸å®Œå…¨ç¡®å®šã€‚æ²¡å…³ç³»ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±ä¸€èµ·æ¥ä»åº•å±‚å®ç°å±‚é¢æ¥å½»åº•æŒæ¡åˆ‡ç‰‡æœºåˆ¶ï¼Œå­¦å®Œå†å›è¿‡å¤´æ¥çœ‹ç›¸ä¿¡è¿™äº›å°±ä¸å†æ˜¯é—®é¢˜äº†ã€‚</p>
<h2 id="ä»å­—èŠ‚ç çœ‹èµ·">ä»å­—èŠ‚ç çœ‹èµ·</h2>
<pre><code class="language-py">In [1]: def test():
   ...:     a = [1, 2, 3, 4, 5]
   ...:     b = a[1:-1]
   ...:

In [2]: import dis

In [3]: dis.dis(test)
  2           0 LOAD_CONST               1 (1)
              2 LOAD_CONST               2 (2)
              4 LOAD_CONST               3 (3)
              6 LOAD_CONST               4 (4)
              8 LOAD_CONST               5 (5)
             10 BUILD_LIST               5
             12 STORE_FAST               0 (a)

  3          14 LOAD_FAST                0 (a)
             16 LOAD_CONST               1 (1)
             18 LOAD_CONST               6 (-1)
             20 BUILD_SLICE              2
             22 BINARY_SUBSCR
             24 STORE_FAST               1 (b)
</code></pre>
<p>è¿™æ®µå­—èŠ‚ç åˆ†ä¸ºä¿©ä¸ªéƒ¨åˆ†ï¼Œä¸ŠåŠéƒ¨åˆ†æ„å»ºåˆ—è¡¨ aï¼Œä¸‹åŠéƒ¨åˆ†é€šè¿‡å¯¹ a åˆ‡ç‰‡å¾—åˆ°åˆ—è¡¨ bã€‚å’Œæœ¬æ–‡ä¸»é¢˜ç›¸å…³çš„ä¿©ä¸ªå­—èŠ‚ç æŒ‡ä»¤å°±åœ¨ä¸‹åŠéƒ¨åˆ†ï¼Œå®ƒä»¬æ˜¯ï¼š</p>
<ul>
<li>BUILD_SLICE</li>
<li>BINARY_SUBSCR</li>
</ul>
<h2 id="build_slice">BUILD_SLICE</h2>
<pre><code class="language-py">16 LOAD_CONST               1 (1)
18 LOAD_CONST               6 (-1)
20 BUILD_SLICE              2
</code></pre>
<p>åœ¨æ‰§è¡Œ BUILD_SLICE ä¹‹å‰ï¼Œè§£é‡Šå™¨å°† slice çš„ä¿©ä¸ªå…³é”®å‚æ•° start å’Œ stop å‹å…¥æ ˆï¼Œç„¶åæ‰§è¡Œ BUILD_SLICE æŒ‡ä»¤ï¼Œæ³¨æ„ï¼Œè¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯ 2ã€‚2 ä»£è¡¨æ„å»º slice å¯¹è±¡çš„å‚æ•°åªæœ‰ä¸¤ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶æ²¡æœ‰æ˜¯æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•° stepã€‚</p>
<pre><code class="language-c">  TARGET(BUILD_SLICE) {
      PyObject *start, *stop, *step, *slice;
      if (oparg == 3)
	      step = POP();
      else
	      step = NULL;
      stop = POP();
      start = TOP();
      slice = PySlice_New(start, stop, step);
      Py_DECREF(start);
      Py_DECREF(stop);
      Py_XDECREF(step);
      SET_TOP(slice);
      if (slice == NULL)
	      goto error;
      DISPATCH();
  }
</code></pre>
<p>è¿™æ®µä»£ç æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ ¹æ®ä¼ å…¥çš„å‚æ•°ä¸ªæ•°åˆ¤æ–­ slice æœ‰æ²¡æœ‰ç¬¬ä¸‰ä¸ªå‚æ•° step ï¼Œæœ‰çš„è¯å®ƒåœ¨ BUILD_SLICE ä¹‹å‰è‚¯å®šæ˜¯æœ€åä¸€ä¸ªè¢«å‹å…¥æ ˆçš„ï¼Œç°åœ¨ä»æ ˆä¸­å–å‡ºçš„ç¬¬ä¸€ä¸ªå°±æ˜¯ stepï¼Œæ²¡æœ‰çš„è¯ï¼Œstep è¢«è®¾ä¸º NULLã€‚ç„¶åï¼Œç»§ç»­å–å‡º start å’Œ stopï¼Œå°†è¿™ä¸‰ä¸ªå‚æ•°ä¼ å…¥ <code>PySlice_New</code> å‡½æ•°åˆ›å»ºä¸€ä¸ª slice å¯¹è±¡ï¼Œå†å°†è¿™ä¸ªå¯¹è±¡æ”¾å›æ ˆä¸­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ slice å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆäº†ï¼š</p>
<pre><code class="language-c">  typedef struct {
      PyObject_HEAD
      PyObject *start, *stop, *step;  /* not NULL */
  } PySliceObject;
</code></pre>
<p>ç°åœ¨æ˜ç™½äº†å§ï¼Œ<em>slice å¯¹è±¡å°±æ˜¯ä¸€ä¸ªè®°å½•äº† startï¼Œstopï¼Œstep å€¼ï¼ˆå¯¹è±¡ï¼‰çš„ä¸€ä¸ª Python å¯¹è±¡</em>ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">  static PySliceObject *slice_cache = NULL;
  PyObject *
  PySlice_New(PyObject *start, PyObject *stop, PyObject *step)
  {
      PySliceObject *obj;
      if (slice_cache != NULL) {
  		 /* ä¸ºäº†æ•ˆç‡ï¼ŒPython ä¼šç¼“å­˜ä¸€ä¸ª slice å¯¹è±¡ï¼Œæœ‰ç¼“å­˜å°±çœå¾—ç”³è¯·å†…å­˜äº† */
          obj = slice_cache;
          slice_cache = NULL;
          _Py_NewReference((PyObject *)obj);
      } else {
          obj = PyObject_GC_New(PySliceObject, &amp;PySlice_Type);
          if (obj == NULL)
              return NULL;
      }

      /* step start stop ä¸ºè®¾ç½®ä¼šè¢«ç½®ä¸º None */
      if (step == NULL) step = Py_None;
      Py_INCREF(step);
      if (start == NULL) start = Py_None;
      Py_INCREF(start);
      if (stop == NULL) stop = Py_None;
      Py_INCREF(stop);

      /* è®¾ç½® slice å¯¹è±¡çš„ step start stop */
      obj-&gt;step = step;
      obj-&gt;start = start;
      obj-&gt;stop = stop;

      _PyObject_GC_TRACK(obj);
      return (PyObject *) obj;
  }
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬æ˜ç™½äº†ä¸€ç‚¹ï¼Œå½“æˆ‘ä»¬å¯¹ä¸€ä¸ªåºåˆ—è¿›è¡Œåˆ‡ç‰‡æ—¶ï¼Œè§£é‡Šå™¨ä¼šæ ¹æ®ä¼ å…¥çš„ startï¼Œstopï¼Œstep åˆ›å»ºä¸€ä¸ª slice å¯¹è±¡ï¼Œ<em>slice å¯¹è±¡å’Œä½ è¦åˆ‡ç‰‡çš„åŸåºåˆ—å¹¶æ²¡æœ‰ç›´æ¥çš„å…³ç³»</em>ã€‚</p>
<p>Python æä¾›äº† <code>slice</code> å†…å»ºå‡½æ•°æ¥åˆ›å»º slice å¯¹è±¡ï¼š</p>
<pre><code class="language-py">In [68]: s = slice(1, -1, 2)

In [69]: type(s)
Out[69]: slice
In [70]: s.start
Out[70]: 1

In [71]: s.stop
Out[71]: -1

In [72]: s.step
Out[72]: 2
</code></pre>
<p>ä¸‹é¢çš„ä¿©ç§è·å–åˆ‡ç‰‡çš„æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼š</p>
<pre><code class="language-py">In [73]: a = [1, 2, 3, 4, 5]

In [74]: a[1:-1:2]
Out[74]: [2, 4]

In [75]: a[slice(1, -1, 2)]
Out[75]: [2, 4]
</code></pre>
<h2 id="binary_subscr">BINARY_SUBSCR</h2>
<p>è¿™ä¸ªæŒ‡ä»¤ç¿»è¯‘è¿‡æ¥å«äºŒå…ƒä¸‹æ ‡ï¼Œ a[0] è¿™ç§æ–¹å¼æ˜¯ä¸€å…ƒä¸‹æ ‡ï¼Œå¯ä»¥çŒœæµ‹ä¸€ä¸‹ï¼Œé€šè¿‡ slice å¯¹è±¡å¯¹åºåˆ—åˆ‡ç‰‡å’Œé€šè¿‡ index å¯¹åºåˆ—å–å€¼ç›´æ¥æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹æºç ï¼š</p>
<pre><code class="language-c">  TARGET(BINARY_SUBSCR) {
      PyObject *sub = POP();
      PyObject *container = TOP();
      PyObject *res = PyObject_GetItem(container, sub);
      Py_DECREF(container);
      Py_DECREF(sub);
      SET_TOP(res);
      if (res == NULL)
          goto error;
      DISPATCH();
  }
</code></pre>
<p>è¿™é‡Œä»æ ˆä¸­å–å‡ºæ¥ç»™ sub çš„å¯¹è±¡å°±æ˜¯æˆ‘ä»¬å‰é¢æ„å»ºçš„ slice å¯¹è±¡ï¼Œè€Œ container å¯¹è±¡å°±æ˜¯æˆ‘ä»¬è¦åˆ‡ç‰‡çš„åŸåˆ—è¡¨ï¼Œå®ƒä»¬è¢«ä¼ ç»™äº† <code>PyObject_GetItem</code>ã€‚</p>
<p>ç­”æ¡ˆæ˜¯ä¸æ˜¯å‘¼ä¹‹æ¬²å‡ºäº†ï¼ŸäºŒå…ƒä¸‹æ ‡ä¹Ÿå°±æ˜¯åˆ‡ç‰‡æ˜¯é€šè¿‡ <code>PyObject_GetItem</code> è¿™ä¸ªå‡½æ•°å¤„ç†çš„ï¼Œå®ƒä¹Ÿæ˜¯ç”¨æ¥å¤„ç†ä¸€å…ƒä¸‹æ ‡çš„ï¼</p>
<pre><code class="language-c">  PyObject *
  PyObject_GetItem(PyObject *o, PyObject *key)
  {
      PyMappingMethods *m;

      if (o == NULL || key == NULL) {
          return null_error();
      }

      m = o-&gt;ob_type-&gt;tp_as_mapping;
      if (m &amp;&amp; m-&gt;mp_subscript) {
          PyObject *item = m-&gt;mp_subscript(o, key);
          assert((item != NULL) ^ (PyErr_Occurred() != NULL));
          return item;
      }

      if (o-&gt;ob_type-&gt;tp_as_sequence) {
          if (PyIndex_Check(key)) {
              Py_ssize_t key_value;
              key_value = PyNumber_AsSsize_t(key, PyExc_IndexError);
              if (key_value == -1 &amp;&amp; PyErr_Occurred())
                  return NULL;
              return PySequence_GetItem(o, key_value);
          }
          else if (o-&gt;ob_type-&gt;tp_as_sequence-&gt;sq_item)
              return type_error(&quot;sequence index must &quot;
                                &quot;be integer, not '%.200s'&quot;, key);
      }

      return type_error(&quot;'%.200s' object is not subscriptable&quot;, o);
 }
</code></pre>
<p><code>PyObject_GetItem</code> æ˜¯ç”¨æ¥å®ç°å¤šæ€çš„ï¼Œå®ƒæ ¹æ®è¦åˆ‡ç‰‡å¯¹è±¡çš„ä¸åŒï¼Œè°ƒç”¨å¯¹è±¡çš„ç‰¹å®šå‡½æ•°åšå‡ºä¸åŒçš„å¤„ç†ã€‚æˆ‘ä»¬åé¢ä¼šè®²åœ¨åˆ—è¡¨åˆ—è¡¨çš„å¤„ç†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æ˜ç™½ï¼Œ<em>åºåˆ—çš„ä¸‹æ ‡å¯ä»¥æ˜¯ int å¯¹è±¡æˆ–è€…æ˜¯ slice å¯¹è±¡ï¼Œå¤„ç†å®ƒä»¬çš„å‡½æ•°æ¥å£æ˜¯ä¸€æ ·çš„</em>ã€‚</p>
<pre><code class="language-py">In [76]: a = [1, 2, 3, 4, 5]

In [77]: a.__getitem__(1)
Out[77]: 2

In [78]: a.__getitem__(slice(1, -1, 2))
Out[78]: [2, 4]

In [80]: s = 'python'

In [81]: s.__getitem__(1)
Out[81]: 'y'

In [82]: s.__getitem__(slice(1, -1, 2))
Out[82]: 'yh'
</code></pre>
<h2 id="åˆ‡ç‰‡å‚æ•°çš„å¤„ç†">åˆ‡ç‰‡å‚æ•°çš„å¤„ç†</h2>
<p>start ã€stop å’Œ step çš„å€¼å¯ä»¥æ˜¯æ•´æ•°ï¼Œå¯ä»¥æ˜¯è´Ÿæ•°ï¼Œstart å’Œ stop çš„å€¼è¿˜å¯èƒ½è¶…è¿‡åˆ—è¡¨çš„é•¿åº¦ï¼Œå¯¹äºç‰¹æ®Š stepã€stop å€¼çš„å¤„ç†ä¹Ÿå°±å†³å®šäº†åˆ‡ç‰‡çš„ç»“æœï¼Œè€Œè¿™äº›å¤„ç†æ­£æ˜¯åœ¨<code>PySlice_GetIndicesEx</code> è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„ï¼Œç†è§£åˆ‡ç‰‡è¡Œä¸ºçš„æ ¸å¿ƒå°±æ˜¯è¦ç†è§£è¿™ä¸ªå‡½æ•°çš„é€»è¾‘ã€‚æˆ‘ä»¬æ‹†å¼€æ¥çœ‹è¿™ä¸ªå‡½æ•°æ˜¯æ€ä¹ˆå¤„ç† start stop step çš„ã€‚</p>
<ol>
<li>step çš„å¤„ç†</li>
</ol>
<pre><code class="language-c"> if (r-&gt;step == Py_None) {
		 /* step é»˜è®¤æ˜¯ 1ï¼Œè¿™ä¸éš¾ç†è§£ */
      *step = 1;
  } else {
      if (!_PyEval_SliceIndex(r-&gt;step, step)) return -1;
		 /* step ä¸èƒ½ä¸ºé›¶ï¼Œå¦åˆ™æŠ¥ ValueErrorï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå¼‚å¸¸æ˜¯åœ¨æ‰§è¡Œ BINARY_SUBSCR æ‰æŠ¥å‡ºæ¥ï¼Œ
       * åœ¨åˆ›å»º slice å¯¹è±¡æ—¶å¦‚æœ step ä¸º 0 å¹¶ä¸ä¼šæŠ¥é”™ */
      if (*step == 0) {
          PyErr_SetString(PyExc_ValueError, &quot;slice step cannot be zero&quot;);
          return -1;
      }
      /* step çš„æœ€å°å€¼ï¼Œä»–æ˜¯æ ¹æ® size_t æ¥å®šä¹‰çš„
       * #define PY_SSIZE_T_MAX ((Py_ssize_t)(((size_t)-1)&gt;&gt;1))
       * æ‰€ä»¥åœ¨ 32 ä¸ºç³»ç»Ÿä¸Šå°±æ˜¯ -2147483647 */
      if (*step &lt; -PY_SSIZE_T_MAX)
          *step = -PY_SSIZE_T_MAX;
  }
</code></pre>
<ol start="2">
<li>start çš„å¤„ç†</li>
</ol>
<pre><code class="language-c">  /* å½“ start æœªè®¾ç½®æ—¶çš„é»˜è®¤å€¼ï¼Œlength æ˜¯åºåˆ—çš„é•¿åº¦
   * å¦‚æœåˆ‡ç‰‡ä»åºåˆ—å¤´éƒ¨å¼€å§‹ï¼ˆstep &gt; 0ï¼‰ï¼Œstart = 0
   * å¦‚æœåˆ‡ç‰‡ä»åºåˆ—æœ«å°¾å¼€å§‹ï¼ˆstep &lt; 0ï¼‰ï¼Œstart = length - 1 */
  defstart = *step &lt; 0 ? length-1 : 0;
  if (r-&gt;start == Py_None) {
      *start = defstart;
  }
  else {
      if (!_PyEval_SliceIndex(r-&gt;start, start)) return -1;
      /* å¦‚æœ start æ˜¯è´Ÿæ•°ï¼Œå…¶å®æ˜¯é€šè¿‡åŠ ä¸Šåºåˆ—é•¿åº¦è½¬åŒ–æˆæ­£æ•°çš„ a[-1:] &lt;=&gt; a[4:] */
      if (*start &lt; 0) *start += length;
      /* å¦‚æœåŠ ä¸Š length è¿˜æ˜¯å°äº 0ï¼Œä¹Ÿå°±æ˜¯ -start è¶…å‡ºäº†åºåˆ—é•¿åº¦ï¼Œè¿™æ—¶å€™ä¼šæ ¹æ® step çš„æ­£è´Ÿå°†start
       * è®¾ç½®ä¸ºåºåˆ—çš„å¼€å§‹ï¼ˆ0ï¼‰æˆ–ç»“æŸï¼ˆ-1ï¼‰ä½ç½®
       * a[-6:-1]    &lt;=&gt; a[0:-1]
       * a[-6:-1:-1] &lt;=&gt; a[-1:-1:-1] */
      if (*start &lt; 0) *start = (*step &lt; 0) ? -1 : 0;
		/* start è¶…å‡ºäº†åºåˆ—é•¿åº¦ï¼Œè¿™æ—¶å€™ä¼šæ ¹æ® step çš„æ­£è´Ÿå°†start
       * è®¾ç½®ä¸ºåºåˆ—çš„é•¿åº¦æˆ–åºåˆ—é•¿åº¦å‡ 1ï¼ˆæœ€åä¸€ä¸ªå…ƒç´ ï¼‰
       * a[6:-1]    &lt;=&gt; a[5:-1]
       * a[6:-1:-1] &lt;=&gt; a[4:-1:-1] */
      if (*start &gt;= length)
          *start = (*step &lt; 0) ? length - 1 : length;
  }
</code></pre>
<ol start="3">
<li>stop çš„å¤„ç†</li>
</ol>
<pre><code class="language-c">  /* å½“ stop æœªè®¾ç½®æ—¶çš„é»˜è®¤å€¼ï¼Œlength æ˜¯åºåˆ—çš„é•¿åº¦
   * å¦‚æœåˆ‡ç‰‡ä»åºåˆ—å¤´éƒ¨å¼€å§‹ï¼ˆstep &gt; 0ï¼‰ï¼Œstop = lengthï¼Œæ¯”æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡å¤š 1
   * å¦‚æœåˆ‡ç‰‡ä»åºåˆ—æœ«å°¾å¼€å§‹ï¼ˆstep &lt; 0ï¼‰ï¼Œstart = -1ï¼Œæ¯”ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡å°‘ 1 */
 defstop = *step &lt; 0 ? -1 : length;
 if (r-&gt;stop == Py_None) {
      *stop = defstop;
  } else {
      if (!_PyEval_SliceIndex(r-&gt;stop, stop)) return -1;
      /* å¦‚æœ stop æ˜¯è´Ÿæ•°ï¼Œå…¶å®æ˜¯é€šè¿‡åŠ ä¸Šåºåˆ—é•¿åº¦è½¬åŒ–æˆæ­£æ•°çš„ a[:-1] &lt;=&gt; a[:4] */
      if (*stop &lt; 0) *stop += length;
      /* å¦‚æœåŠ ä¸Š length è¿˜æ˜¯å°äº 0ï¼Œä¹Ÿå°±æ˜¯ -stop è¶…å‡ºäº†åºåˆ—é•¿åº¦ï¼Œè¿™æ—¶å€™ä¼šæ ¹æ® step çš„æ­£è´Ÿå°† stop
       * è®¾ç½®ä¸ºåºåˆ—çš„å¼€å§‹ï¼ˆ0ï¼‰æˆ–ç»“æŸï¼ˆ-1ï¼‰ä½ç½®
       * a[3:-6]    &lt;=&gt; a[3:0]
       * a[3:-6:-1] &lt;=&gt; a[3::-1] */
      if (*stop &lt; 0) *stop = (*step &lt; 0) ? -1 : 0;
      if (*stop &gt;= length)
          *stop = (*step &lt; 0) ? length - 1 : length;
  }

</code></pre>
<ol start="4">
<li>slicelength çš„å¤„ç†ï¼Œslicelength æ˜¯åˆ‡ç‰‡ç»“æœçš„é•¿åº¦</li>
</ol>
<pre><code class="language-c">  /* å¦‚ï¼ša[6:1]      å¤„ç†å start = 6 stop = 1 start &gt; stop
   *    a[6:-1]     å¤„ç†å start = 6 stop = 4 start &gt; stop
   *    a[2:3:-1]   å¤„ç†å start = 2 stop = 3 stop &gt;= start
   *    a[-3:-2:-1] å¤„ç†å start = 2 stop = 3 stop &gt;= start */
  if ((*step &lt; 0 &amp;&amp; *stop &gt;= *start)
      || (*step &gt; 0 &amp;&amp; *start &gt;= *stop)) {
      *slicelength = 0;
  }
  else if (*step &lt; 0) {
      *slicelength = (*stop-*start+1)/(*step)+1;
  }
  else {
      *slicelength = (*stop-*start-1)/(*step)+1;
  }
</code></pre>
<p>è®°ä½å‡ ç‚¹ï¼š</p>
<ul>
<li>åˆ‡ç‰‡ç»“æœæ˜¯é€šè¿‡ startã€stop å¤„ç†åçš„å€¼å†³å®šçš„ï¼Œä» start å¼€å§‹æ­¢äº stop ä¸åŒ…æ‹¬ stopï¼Œ[start, stop)</li>
<li>å¦‚æœ step &gt; 0ï¼Œä» start ä½ç½®å¾€åï¼Œæ¯ step å–ä¸€ä¸ªå€¼ï¼Œå¦‚æœ start &gt;= stopï¼Œç»“æœä¸ºç©º</li>
<li>å¦‚æœ step &lt; 0ï¼Œä» start ä½ç½®å¾€å‰ï¼Œæ¯ step å–ä¸€ä¸ªå€¼ï¼Œå¦‚æœ start &lt;= stopï¼Œç»“æœä¸ºç©º</li>
<li>start æˆ– stop ä¸ºè´Ÿæ•°æ—¶ï¼Œå¦‚æœç»å¯¹å€¼åœ¨ length å†…ï¼Œé‚£ä¹ˆå’Œ length + start æˆ– stop ç­‰ä»·</li>
<li>start æˆ– stop ä¸ºè´Ÿæ•°æ—¶ï¼Œå¦‚æœç»å¯¹å€¼è¶…è¿‡ length ï¼Œé‚£ä¹ˆå°±è¦æ ¹æ®åˆ‡ç‰‡æ–¹å‘å°† start æˆ– stop è½¬æ¢ä¸ºè¾¹ç•Œå€¼</li>
</ul>
<h2 id="åˆ—è¡¨åˆ‡ç‰‡">åˆ—è¡¨åˆ‡ç‰‡</h2>
<p>åˆ‡ç‰‡å¯ä»¥ä½œç”¨äºæ‰€æœ‰åºåˆ—å¯¹è±¡ï¼šåˆ—è¡¨ï¼Œå­—ç¬¦ä¸²ï¼Œå…ƒç»„ã€‚æˆ‘ä»¬æ—¥å¸¸æœ€å¸¸ç”¨çš„å°±æ˜¯åˆ—è¡¨åˆ‡ç‰‡ï¼Œè¿™é‡Œå°±æ·±å…¥çœ‹ä¸‹åˆ—è¡¨åˆ‡ç‰‡çš„å¤„ç†ï¼Œå…¶ä»–ä¿©ç§å¤„ç†æ–¹å¼åº”è¯¥ä¹Ÿç±»ä¼¼ã€‚</p>
<pre><code class="language-c"> static PyMappingMethods list_as_mapping = {
      ...
      (binaryfunc)list_subscript,
		...
 }

 static PyMethodDef list_methods[] = {
		{&quot;__getitem__&quot;, (PyCFunction)list_subscript, METH_O|METH_COEXIST, getitem_doc},
		...
 }
</code></pre>
<p>æ·±å…¥åˆ° list å¯¹è±¡çš„æºç åå‘ç°ï¼Œ <code>o-&gt;ob_type-&gt;tp_as_mapping-&gt;mp_subscript</code>ï¼ˆå›çœ‹ PyObject_GetItem çš„é€»è¾‘ï¼‰å’Œ <code>list.__getitem__</code> éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå‡½æ•°â€”â€”<code>list_subscript</code>ï¼Œlist çš„åˆ‡ç‰‡æ­£æ˜¯åœ¨è¿™é‡Œå¤„ç†çš„ï¼š</p>
<pre><code class="language-c">  static PyObject *list_subscript(PyListObject* self, PyObject* item)
  {
		...
		/* å¦‚æœä¸‹æ ‡æ˜¯ slice å¯¹è±¡ */
      if (PySlice_Check(item)) {
          Py_ssize_t start, stop, step, slicelength, cur, i;
          PyObject* result;
          PyObject* it;
          PyObject **src, **dest;

			 /* ä» slice å¯¹è±¡è§£æå¹¶å¤„ç† start stop step å’Œ slicelength */
          if (PySlice_GetIndicesEx(item, Py_SIZE(self),
                           &amp;start, &amp;stop, &amp;step, &amp;slicelength) &lt; 0) {
              return NULL;
          }

			 /* ä» start stop step è®¡ç®—å‡ºåˆ‡ç‰‡ç»“æœçš„é•¿åº¦å°äºç­‰äº 0ï¼Œè¿”å›ç©ºåˆ—è¡¨ */
          if (slicelength &lt;= 0) {
              return PyList_New(0);
          }
          /* ç»“æœé•¿åº¦å¤§äº 0 è€Œ step = 1ï¼Œäº¤ç»™ list_slice å¤„ç† */
          else if (step == 1) {
              return list_slice(self, start, stop);
          }
          else {
              /* åˆ›å»ºä¸€ä¸ªä¸ç»“æœé•¿åº¦ç›¸ç­‰çš„åˆ—è¡¨å¯¹è±¡ */
              result = PyList_New(slicelength);
              if (!result) return NULL;

              src = self-&gt;ob_item;
              dest = ((PyListObject *)result)-&gt;ob_item;
              /* ä» start å¼€å§‹ï¼Œæ¯æ¬¡å‰è¿› stepï¼Œå¼€å§‹ copy åˆ—è¡¨å…ƒç´  */
              for (cur = start, i = 0; i &lt; slicelength;
                   cur += (size_t)step, i++) {
                  /* ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä»åŸåˆ—è¡¨æ‹·è´å…ƒç´ åˆ°åˆ‡ç‰‡ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„èµ‹å€¼ï¼Œæ‰€ä»¥åˆ‡ç‰‡æ˜¯æµ…æ‹·è´ */
                  it = src[cur];
                  Py_INCREF(it);
                  dest[i] = it;
              }

              return result;
      }
		...
 }
</code></pre>
<p>å…¶ä¸­çš„ <code>list_slice</code> å‡½æ•°åƒæ˜¯ <code>list_subscript</code> å½“ step ç­‰äº 1 æ—¶çš„ç®€åŒ–ç‰ˆï¼š</p>
<pre><code class="language-c">  static PyObject *
  list_slice(PyListObject *a, Py_ssize_t ilow, Py_ssize_t ihigh)
  {
      PyListObject *np;
      PyObject **src, **dest;
      Py_ssize_t i, len;
      if (ilow &lt; 0)
          ilow = 0;
      else if (ilow &gt; Py_SIZE(a))
          ilow = Py_SIZE(a);
      if (ihigh &lt; ilow)
          ihigh = ilow;
      else if (ihigh &gt; Py_SIZE(a))
          ihigh = Py_SIZE(a);
      len = ihigh - ilow;
      np = (PyListObject *) PyList_New(len);
      if (np == NULL)
          return NULL;

      src = a-&gt;ob_item + ilow;
      dest = np-&gt;ob_item;
      for (i = 0; i &lt; len; i++) {
          PyObject *v = src[i];
          Py_INCREF(v);
          dest[i] = v;
      }
      return (PyObject *)np;
  }
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ–‡ä»æºç å±‚é¢å‰–æäº†ä»€ä¹ˆæ˜¯ slice å¯¹è±¡ï¼Œåˆ‡ç‰‡ä¸­å¯¹ startã€stopã€step å€¼çš„å¤„ç†ï¼ŒåŠè™šæ‹Ÿæœºç”Ÿæˆä¸€ä¸ªåˆ—è¡¨åˆ‡ç‰‡çš„æ•´ä¸ªè¿‡ç¨‹ã€‚å¼„æ‡‚äº† Python å¯¹ startã€stopã€step çš„å¤„ç†é€»è¾‘åï¼Œæ–‡ç« å¼€å§‹å¤„çš„å‡ é“é¢˜ä¹Ÿå°±ä¸èƒ½å¾—å‡ºç­”æ¡ˆäº†ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9C%8B%E8%B5%B7">ä»å­—èŠ‚ç çœ‹èµ·</a></li>
<li><a href="#build_slice">BUILD_SLICE</a></li>
<li><a href="#binary_subscr">BINARY_SUBSCR</a></li>
<li><a href="#%E5%88%87%E7%89%87%E5%8F%82%E6%95%B0%E7%9A%84%E5%A4%84%E7%90%86">åˆ‡ç‰‡å‚æ•°çš„å¤„ç†</a></li>
<li><a href="#%E5%88%97%E8%A1%A8%E5%88%87%E7%89%87">åˆ—è¡¨åˆ‡ç‰‡</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://protream.github.io/post/yong-python-xie-yi-ge-ming-ling-xing-huo-che-piao-cha-kan-qi/">
              <h3 class="post-title">
                ç”¨ Python å†™ä¸€ä¸ªå‘½ä»¤è¡Œç«è½¦ç¥¨æŸ¥çœ‹å™¨
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">&nbsp;Gridea</a>
  <a class="rss" href="https://protream.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
